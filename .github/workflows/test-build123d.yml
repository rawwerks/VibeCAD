name: Test build123d Examples

on:
  push:
    branches: [main]
    paths:
      - 'plugins/build123d/**'
  pull_request:
    branches: [main]
    paths:
      - 'plugins/build123d/**'
  workflow_dispatch:

jobs:
  check-version:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check plugin version was bumped
        run: |
          echo "Checking if plugin version was bumped..."

          # Get version from PR branch
          PR_VERSION=$(jq -r '.version' plugins/build123d/.claude-plugin/plugin.json)
          echo "PR version: $PR_VERSION"

          # Get version from main branch
          git fetch origin main
          MAIN_VERSION=$(git show origin/main:plugins/build123d/.claude-plugin/plugin.json | jq -r '.version')
          echo "Main version: $MAIN_VERSION"

          # Compare versions
          if [ "$PR_VERSION" = "$MAIN_VERSION" ]; then
            echo "::error::Plugin version not bumped! Current: $MAIN_VERSION"
            echo "::error::Per CLAUDE.md: New skill = MINOR bump, Modified skill = PATCH bump"
            exit 1
          fi

          echo "✓ Version bumped: $MAIN_VERSION → $PR_VERSION"

  test-examples:
    runs-on: ubuntu-latest
    needs: [check-version]
    if: always() && (needs.check-version.result == 'success' || needs.check-version.result == 'skipped')

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Run core examples (01-08)
        working-directory: plugins/build123d/skills/build123d/references/examples
        run: |
          echo "Testing core examples (01-08)..."
          failed=0

          for f in 0[1-8]_*.py; do
            if [ -f "$f" ]; then
              echo "=== Testing $f ==="
              if uvx --from build123d python "$f" 2>&1; then
                echo "✓ $f passed"
              else
                echo "✗ $f FAILED"
                failed=$((failed + 1))
              fi
              echo ""
            fi
          done

          if [ $failed -gt 0 ]; then
            echo "::error::$failed core example(s) failed"
            exit 1
          fi
          echo "All core examples passed!"

      - name: Run bd_warehouse examples (09-14)
        working-directory: plugins/build123d/skills/build123d/references/examples
        run: |
          echo "Testing bd_warehouse examples (09-14)..."
          failed=0

          for f in 09_*.py 1[0-4]_*.py; do
            if [ -f "$f" ]; then
              echo "=== Testing $f ==="
              if uvx --from build123d --with bd-warehouse python "$f" 2>&1; then
                echo "✓ $f passed"
              else
                echo "✗ $f FAILED"
                failed=$((failed + 1))
              fi
              echo ""
            fi
          done

          if [ $failed -gt 0 ]; then
            echo "::error::$failed bd_warehouse example(s) failed"
            exit 1
          fi
          echo "All bd_warehouse examples passed!"

      - name: Run gggears examples (15-20)
        working-directory: plugins/build123d/skills/build123d/references/examples
        run: |
          echo "Testing gggears examples (15-20)..."
          failed=0

          for f in 1[5-9]_*.py 20_*.py; do
            if [ -f "$f" ]; then
              echo "=== Testing $f ==="
              if uvx --from build123d --with gggears python "$f" 2>&1; then
                echo "✓ $f passed"
              else
                echo "✗ $f FAILED"
                failed=$((failed + 1))
              fi
              echo ""
            fi
          done

          if [ $failed -gt 0 ]; then
            echo "::error::$failed gggears example(s) failed"
            exit 1
          fi
          echo "All gggears examples passed!"

      - name: Run blind spot examples (21-27)
        working-directory: plugins/build123d/skills/build123d/references/examples
        run: |
          echo "Testing blind spot examples (21-27)..."
          failed=0

          for f in 2[1-7]_*.py; do
            if [ -f "$f" ]; then
              echo "=== Testing $f ==="
              if uvx --from build123d python "$f" 2>&1; then
                echo "✓ $f passed"
              else
                echo "✗ $f FAILED"
                failed=$((failed + 1))
              fi
              echo ""
            fi
          done

          if [ $failed -gt 0 ]; then
            echo "::error::$failed blind spot example(s) failed"
            exit 1
          fi
          echo "All blind spot examples passed!"

      - name: Run harness on examples with 'result' variable
        working-directory: plugins/build123d/skills/build123d
        run: |
          echo "Running harness tests..."

          # Examples known to have 'result' variable
          examples=(
            "references/examples/21_split_and_mirror.py"
            "references/examples/22_plane_offsets_positions.py"
            "references/examples/23_stadium_slotoverall.py"
            "references/examples/24_intersection_corners.py"
            "references/examples/25_face_local_coordinates.py"
            "references/examples/26_construction_sequence.py"
            "references/examples/27_profile_vs_primitives.py"
          )

          for example in "${examples[@]}"; do
            if [ -f "$example" ]; then
              echo "=== Harness: $example ==="
              uvx --from build123d python scripts/harness.py "$example" || exit 1
              echo ""
            fi
          done

          echo "All harness tests passed!"

      - name: Verify GLB files generated
        working-directory: plugins/build123d/skills/build123d/references/examples
        run: |
          echo "Checking for generated GLB files..."
          glb_count=$(ls -1 *.glb 2>/dev/null | wc -l)
          echo "Found $glb_count GLB files"

          if [ "$glb_count" -lt 10 ]; then
            echo "::error::Expected at least 10 GLB files, found $glb_count"
            exit 1
          fi

          echo "GLB generation verified!"
